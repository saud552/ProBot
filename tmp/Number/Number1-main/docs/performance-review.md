## مراجعة الأداء والكفاءة – Numbers1

### ملخص
أثناء قراءة الملفات `index.php`, `member.php`, `admin.php`, `api.php`, و `contries.php` اتضح أن البنية الحالية تعتمد على شيفرة إجرائية متشابكة وقراءات/كتابات مكررة للملفات مما يعوق الأداء وقابلية التوسّع. أدناه أهم فرص التحسين مرتبة حسب الأولوية.

### فرص التحسين

- **طبقة الاتصال بتيليجرام (`index.php` الدالة `bot`)**
  - كل استدعاء يفتح اتصال `curl` جديد بدون إعادة استخدام أو مهلات صريحة، ويكتب الاستجابة إلى `error.txt` مهما كانت النتيجة. الاعتماد على `json_decode` مباشرة داخل الدالة يحجب تفاصيل الخطأ.
  - **التحسين المقترح:** إنشاء عميل HTTP واحد مع مهلات قياسية، دعم إعادة المحاولة، وتغليف الاستجابات في كائن نتيجة يمرر الأخطاء للمستوى الأعلى. تسجيل الأخطاء يجب أن يكون شرطياً مع مستوى logging.

- **قراءة/كتابة الملفات (`index.php` الأسطر 175-190 وما بعدها)**
  - تتم قراءة سبعة ملفات JSON في كل تحديث وارد ثم تُحفظ بنفس الشكل عبر دوال `save*` متعددة. عدم وجود قفل أو طبقة تخزين مؤقت قد يؤدي إلى سباقات كتابة وتدهور في نظام الملفات.
  - **التحسين المقترح:** إنشاء مستودع تخزين موحد (Repository) يحافظ على نسخة محملة بذاكرة قصيرة الأجل، ويستخدم `flock` أو قاعدة بيانات خفيفة (SQLite) لتأمين الكتابة عند الضغط العالي.

- **إدارة اللغات (`member.php`)**
  - مصفوفات الترجمة الضخمة موجودة داخل الملف وتُقرأ بالكامل في كل طلب، ولا يوجد فصل بين البيانات والمنطق مما يجعل التوسعة للغات جديدة صعباً.
  - **التحسين المقترح:** نقل الترجمات إلى ملفات مستقلة (مثلاً `lang/ar.php`)، وبناء مدير لغات يقوم بتحميل الملف مرة واحدة مع تخزين وسيط وإسقاط النصوص غير المستخدمة.

- **تعدد المسؤوليات في `member.php` و`admin.php`**
  - كل ملف يحوي منطق الواجهة، إدارة الحالة، استدعاءات API، وإرسال الرسائل في كتلة واحدة مع استخدام `goto`. هذا يزيد زمن الصيانة ويمنع الاختبار الآلي.
  - **التحسين المقترح:** تقسيم الشيفرة إلى طبقات: `Handlers` للواجهات، `Services` للأعمال (مثل الشراء أو الدعوات)، و`Presenters` لبناء الرسائل. هذا يسهل إضافة ميزات بدون التسبب في تعارضات.

- **التعامل مع واجهة Spider Service (`api.php`)**
  - العنوان الأساسي يحتوي على خطأ مطبعي (`apiKay`)، ويتم بناء الاستعلام عبر دمج السلسلة بدون ترميز URL. لا يوجد فحص لاستجابات HTTP أو مهلة.
  - **التحسين المقترح:** استخدام `http_build_query`، إضافة `curl_setopt` للمهلات ورؤوس `User-Agent`، ورفع استثناءات واضحة عند حالات الخطأ لإعادة المحاولة.

- **عرض الدول والأسعار (`member.php` القسم buy/getNumber)**
  - يتم اجتياز كامل مصفوفة الدول في كل مرة لبناء الأزرار حتى لو لم يتغير شيء، كما تُحمل أسماء الدول لكل لغة من ملف واحد ضخم.
  - **التحسين المقترح:** تخزين القوائم المولدة في ذاكرة مؤقتة قصيرة (cache keyed by language + page)، واستخدام مولد يقوم بتحميل أسماء الدول المطلوبة فقط.

- **التزامن وإدارة النقاط**
  - عند خصم أو إضافة النقاط لا يوجد أي ضمان بأن الملف لم يتغير بين القراءة والكتابة، ما قد يؤدي لفقد بيانات عندما تصل عدة رسائل متزامنة.
  - **التحسين المقترح:** اعتماد قفل ملف أو نقل التخزين إلى قاعدة بيانات موثوقة، مع تطبيق معاملات (transactions) بسيطة لضمان سلامة الرصيد.

- **المراقبة والتنبيهات**
  - لا توجد مقاييس حول أوقات الاستجابة، عدد الطلبات الناجحة/الفاشلة، أو معدل الأخطاء في واجهة Spider أو تيليجرام.
  - **التحسين المقترح:** إضافة قناة مراقبة (metrics/logs) ترفع تقريراً دورياً أو تعتمد على أدوات مثل Prometheus/Grafana عند توفرها، أو على الأقل تلخيص يومي يُرسل إلى قناة خاصة.

### الخطوة التالية
سيتم اعتماد خطة إعادة هيكلة تدريجية:
1. إنشاء بنية مجلدات معيارية (`src/`, `lang/`, `storage/`).
2. بناء طبقات الخدمات والمستودعات المشار إليها أعلاه.
3. نقل الترجمات إلى ملفات مستقلة وإضافة دعم تركي كامل.
4. توسيع اختبارات التحقق اليدوي ورسائل المراقبة لضمان استقرار البوت بعد التغييرات.

