## Unified Bot Architecture (Phase 1)

### أهداف التصميم
- دمج وظائف بوت الأرقام (Number1) وبوت الرشق (TigerSpeed) في نظام واحد قابل للتوسّع.
- الالتزام بمعايير `standards.md`: فصل الاهتمامات، قابلية التطوير، أمان البيانات، ودعم الأداء العالي.
- توحيد الاعتماد على SQLite كمخزن أساسي مع ملفات JSON اختيارية للنسخ الاحتياطي أو التخزين المؤقت الخفيف.

### نظرة عامة على الطبقات
1. **Presentation Layer (`src/Presentation`)**
   - مستقبل التحديثات (Webhook Controller).
   - مدير الحوارات `ConversationRouter` لتوجيه الحالة إلى الوحدات.
   - منشئ الواجهات `KeyboardFactory` يضمن وجود الزرين الرئيسيين:
     - زر قسم شراء الأرقام ➜ (شراء بالدولار، شراء بالنجوم).
     - زر قسم الرشق ➜ (الرشق بالدولار، الرشق بالنجوم).
   - يدعم جميع اللغات المتاحة في `Number1-main/lang/translations.php` مع إمكانية التوسّع.

2. **Domain Layer (`src/Domain`)**
   - `Users`: نموذج موحّد للمستخدم، اللغة، الاشتراك الإجباري، الرصيد متعدد العملات.
   - `Numbers`: منطق شراء الأرقام، تتبّع الأكواد، قنوات الإشعارات.
   - `Smm`: إدارة الأقسام والخدمات والطلبات والخصومات (مستوحى من TigerSpeed).
   - `Wallet`: عمليات الرصيد، الشحن، التحويل بين الدولار/النجوم/العملات المحلية.
   - `Support`: نظام التذاكر والتواصل المباشر.
   - كل وحدة تلتزم بمبادئ SOLID، ويتم حقن الاعتمادات عبر واجهات.

3. **Infrastructure Layer (`src/Infrastructure`)**
    - `Database`: موصل SQLite (PDO) مع فئات Repository (مثل `UserRepository`, `OrderRepository`).
    - `Storage`: موفّر JSON اختياري (لترحيل البيانات أو التخزين المؤقت) مع قفل ملفي.
    - `Integrations`: مزودو الخدمات الخارجيون
        - Spider Service (الأرقام).
        - tg-accounts.com (الأرقام الإضافية).
        - Orbitexa والمزودون الآخرون لخدمات SMM.
    - `Logging`: قنوات سجل موحّدة (ملفات داخل `logs/`).

### توحيد قواعد البيانات
- **SQLite**: ملف قاعدة بيانات واحد يجمع جميع الجداول المطلوبة من النظامين السابقين.
  - أمثلة على الجداول: `users`, `wallets`, `referrals`, `orders_numbers`, `orders_smm`, `services`, `countries`, `settings`, `tickets`, `translations`.
- **JSON**: يبقى لاستخدامات محدودة:
  - نسخ احتياطية خفيفة (`storage/backups/*.json`).
  - تخزين مؤقت لعناصر صغيرة (مثل إعدادات واجهة أو cache للترجمات) مع سياسة تفريغ واضحة.
- يتم توفير سكربت `setup/schema.sql` (مبني على SQLite) لإنشاء الجداول وضمان التوافق مع البيانات الحالية.

### إدارة اللغات
- سيتم نقل محتوى `Number1-main/lang/translations.php` إلى `lang/translations.php` في المشروع الجديد بدون فقد أي لغة.
- سيتم التفريق بين:
  - `strings` العامة.
  - عناوين الأزرار الرئيسية المطلوبة في الواجهة الجديدة.
- سيضمن `LanguageManager` تحميل الترجمات مرة واحدة مع دعم fallback.

### واجهة المستخدم (المتطلبات الأساسية)
1. **القائمة الرئيسية**
   - زر 1: `شراء الأرقام` ➜ قائمة فرعية تتضمن:
     - `شراء بالدولار`.
     - `شراء بالنجوم`.
   - زر 2: `قسم الرشق` ➜ قائمة فرعية تتضمن:
     - `الرشق بالدولار`.
     - `الرشق بالنجوم`.
   - الأزرار الثانوية (الدعم، الرصيد، التذاكر، تغيير اللغة، ...إلخ) تُضاف أسفل الزرين الرئيسيين وفق احتياج كل وحدة.
2. **تجربة متعددة اللغات**
   - كل رسالة وزر يمر عبر نظام الترجمة.
   - يتم التقليل من النصوص الصلبة (Hard-coded strings) التزاماً بمعيار الجودة.

### خطة التنفيذ (هذا المستند يغطّي المرحلة الأولى)
1. إنشاء البنية المجلدية (تم التنفيذ).
2. تعريف ملف الإعدادات (SQLite، مفاتيح API) عبر `.env` (سيُضاف لاحقاً).
3. نقل الترجمات، ثم بناء `LanguageManager` الجديد.
4. إعداد طبقة الاتصال بـSQLite مع مستودع تجريبي.
5. تهيئة واجهات Presentation (القائمة الرئيسية + الزرين الرئيسيين).
6. تفكيك منطق Number1 وTigerSpeed ودمجه تدريجياً في الوحدات الجديدة.

سيتم تحديث هذا المستند مع تقدم المراحل لضمان أن كل خطوة تلتزم بالمعايير المطلوبة.
